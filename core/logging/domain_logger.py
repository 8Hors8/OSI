"""
domain_logger.py

Модуль содержит инфраструктурные компоненты доменного логирования.

Назначение модуля:
- перехват стандартных сообщений logging;
- сохранение лог-событий в структурированном виде;
- подготовка данных для использования в GUI или других слоях приложения.

Модуль НЕ отвечает за:
- вывод логов в консоль;
- форматирование текстовых логов;
- бизнес-логику обработки ошибок.
"""

import logging


class DomainLogListener(logging.Handler):
    """
    Слушатель логов для доменного уровня приложения.

    Класс наследуется от logging.Handler и предназначен для:
    - перехвата лог-сообщений из стандартного logging;
    - извлечения структурированных данных из LogRecord;
    - сохранения событий в переданное хранилище (обычно список).

    Используется как инфраструктурный слой между:
    - логированием в коде (logger.error / logger.warning / logger.info);
    - GUI или другим потребителем событий (например, отчёт, алертинг).

    Пример использования:
        log_events = []
        handler = DomainLogListener(log_events)
        handler.setLevel(logging.WARNING)
        logging.getLogger().addHandler(handler)

    После выполнения программы список log_events будет содержать
    все перехваченные события заданного уровня и выше.
    """

    def __init__(self, storage: list):
        """
        Инициализирует слушатель логов.

        :param storage: Изменяемое хранилище (обычно list),
                        в которое будут добавляться лог-события.
                        Формат одного события — словарь.
        """
        super().__init__()
        self.storage = storage

    def emit(self, record: logging.LogRecord) -> None:
        """
        Обрабатывает одно лог-событие.

        Метод вызывается системой logging автоматически
        при поступлении нового LogRecord.

        Извлекает из record:
        - уровень логирования;
        - имя логгера (модуля);
        - текст сообщения;
        - номер строки;
        - дополнительный доменный код (если передан через extra).

        Результат сохраняется в self.storage в виде словаря.

        :param record: Объект LogRecord, сформированный logging.
        """

        self.storage.append({
            "level": record.levelname,
            "module": record.name,
            "message": record.getMessage(),
            "line": record.lineno,
            "code": getattr(record, "code", None),
        })
